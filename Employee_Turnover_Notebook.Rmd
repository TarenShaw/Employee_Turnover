---
title: "R Notebook"
output:
  pdf_document:
    latex_engine: xelatex
    highlight: tango
---
Employee turnover is generally defined as the number of employees who leave a company within a certain period, typically one year. Employee turnover can be measured throughout the whole company or within individual departments. Its very important for HR to keep tabs not only on the total turnover rate within an organization but also within individual departments. Only when we compare turnover between companies of the same industry or within similar departments can we truly begin to establish conclusions if it is a problem or not.

High turnover does not necessarily indicate that there is an issue, as many industries and job profiles have a high rotation of employees. However, if we compare turnover rates within industries and between similar departments, we can start to pick out discrepancies within our organization and decide weather we need to make some change and implement a strategy to lower turnover. 
There are many tools and services today which can help HR create metrics that analyse their companyâ€™s workforce. During my time in University, I took a very keen liking to R programming, which is a programming language designed for statistical analysis, data manipulation and creating rich and meaningful visualizations. In this post I hope to demonstrate its usefulness in HR functions and especially in the analysis and automation of creating metrics for employee turnover within a company.

I will be using a dataset that I obtained from Kaggle, an extensive community dedicated to data science and which hosts thousands of datasets published by both educational institutions and companys for people to test their data science skills on. The HR dataset I have  

First we load all the packages we will be using for theis study. I recommend installing the package packman and using one of its built in function, p_load, to load/install mutliple packages at a time.

```{r}
# Load Packages
pacman::p_load(tidyverse, readr, lubridate, skimr, kableExtra)
```

We then load the dataset we will use for this project

```{r include=FALSE}
# Load Data
df <- readr::read_csv("HRDataset_v14.csv")
```

And we can skim our data 

```{r}
# Summary or Data
summary(df)
```
Of the 18 character variables, two should be coded as dates, therefore we transform them using a mutate function.

```{r}
# Transform Data
df <- df %>% mutate(
  DateofTermination = mdy(DateofTermination),
  DateofHire = mdy(DateofHire))
```


```{r}
# Find min/max termination date
min_max <- df %>%
  drop_na(DateofTermination) %>%
  summarise(min = min(DateofTermination), max = max(DateofTermination)) %>%
  print()
```

```{r}
# Define years range
years <- seq(from = year(min_max$min), to = year(min_max$max), by = 1) %>%
  as.character()

years
```

```{r}
# number of leavers in a year
n_leavers <- function(year = "2010") {
  df %>%
    filter(year(DateofTermination) == year) %>%
    nrow()
}
```

```{r}
# number of emplyees at beginnning of year
n_emp_year_start <- function(year = "2010") {
  fun_year <- paste(year, "-01-01", sep = "")

  df %>%
    select(DateofHire, DateofTermination) %>%
    filter(
      DateofHire <= fun_year,
      DateofTermination > fun_year | is.na(DateofTermination)
    ) %>%
    nrow()
}
```

```{r}
# number of employees at end of year
n_emp_year_end <- function(year = "2010") {
  year_num_plus <- as.character(as.numeric(year) + 1)
  fun_year <- paste(year_num_plus, "-01-01", sep = "")

  df %>%
    select(DateofHire, DateofTermination) %>%
    filter(
      DateofHire <= fun_year,
      DateofTermination > fun_year | is.na(DateofTermination)
    ) %>%
    nrow()
}
```

```{r}
# Dataframes of Variabel functions
df_count <- function(x) {
  map_dbl(years, x) %>%
    setNames(years) %>%
    as.data.frame() %>%
    setNames("n") %>%
    rownames_to_column("Year")
}
```

```{r}
# Iterate over functions
functions <- c(n_leavers, n_emp_year_start, n_emp_year_end)
func_names <- c("n_leavers", "n_emp_year_start", "n_emp_year_end")

test <- map(functions, df_count) %>% setNames(func_names)
test
```

```{r}
# Plot variables of tunrover function.
var_turn_plt <- function(x, title = "Title") {

  # find the median of x
  print("Median")
  median <- map_dbl(years, x) %>%
    setNames(years) %>%
    as.data.frame() %>%
    setNames("n") %>%
    rownames_to_column("Year") %>%
    summarise(median = median(n)) %>%
    as.numeric() %>%
    print()

  # Plot df with median
  print("Data.frame")
  plt <- map_dbl(years, x) %>%
    setNames(years) %>%
    as.data.frame() %>%
    setNames("n") %>%
    rownames_to_column("Year") %>%
    print() %>%
    ggplot(aes(x = .[, 1], y = .[, 2], group = 1)) +
    geom_line(color = "#0072b1") +
    geom_point(color = "#0072b1") +
    geom_hline(yintercept = median, linetype = "dashed", color = "red") +
    theme_bw() +
    geom_text(aes(label = n), vjust = -0.5) +
    labs(title = title) +
    xlab("Year") +
    ylab("n")

  return(plt)
}

var_turn_plt(n_leavers, "Terminations")
var_turn_plt(n_emp_year_start, "Employees Year Start")
var_turn_plt(n_emp_year_end, "Employees Year End")
```

```{r}
# Employee turnover function
emp_turnover <- function(year = "2010") {

  # Number of leavers
  leavers <- df %>%
    filter(year(DateofTermination) == year) %>%
    nrow()

  # number of employees at beginning of year
  fun_year1 <- paste(year, "-01-01", sep = "")

  start <- df %>%
    select(DateofHire, DateofTermination) %>%
    filter(
      DateofHire <= fun_year1,
      DateofTermination > fun_year1 | is.na(DateofTermination)
    ) %>%
    nrow()

  # Number of employees end of year
  year_num_plus <- as.character(as.numeric(year) + 1)
  fun_year2 <- paste(year_num_plus, "-01-01", sep = "")

  end <- df %>%
    select(DateofHire, DateofTermination) %>%
    filter(
      DateofHire <= fun_year2,
      DateofTermination > fun_year2 | is.na(DateofTermination)
    ) %>%
    nrow()

  # Average number of employees
  avg_emp_period <- (start + end) / 2

  # Enmployee turnover
  (leavers / avg_emp_period) * 100
}

emp_turnover()
```

```{r}
# Map years to emp_turnover function
turnover_rate <- map_dbl(years, emp_turnover) %>%
  setNames(years) %>%
  as.data.frame() %>%
  setNames("TurnoverRate") %>%
  rownames_to_column("Year")
```

```{r}
# Median turnover
median_turnover <- turnover_rate %>%
  summarise(median = median(TurnoverRate)) %>%
  as.numeric() %>%
  print()
```

```{r}
# Graph turnover rate
ggplot(turnover_rate, aes(x = Year, y = TurnoverRate, group = 1)) +
  geom_line(color = "#0072b1") +
  geom_point(color = "#0072b1") +
  geom_text(aes(label = round(TurnoverRate, digits = 2)), vjust = -0.5) +
  geom_hline(yintercept = median_turnover, linetype = "dashed", color = "red") +
  theme_bw()
```

